# sql-challenge
Module 9 Challenge - UWA/edX Data Analytics Bootcamp

Github repository at: [https://github.com/alyssahondrade/sql-challenge.git](https://github.com/alyssahondrade/sql-challenge.git)

## Table of Contents
1. [Introduction](https://github.com/alyssahondrade/sql-challenge/tree/main#introduction)
    1. [Goal](https://github.com/alyssahondrade/sql-challenge/tree/main#goal)
    2. [Repository Structure](https://github.com/alyssahondrade/sql-challenge/tree/main#repository-structure)
    3. [Dataset](https://github.com/alyssahondrade/sql-challenge/tree/main#dataset)
2. [Approach](https://github.com/alyssahondrade/sql-challenge/tree/main#approach)
    1. [Data Modelling](https://github.com/alyssahondrade/sql-challenge/tree/main#data-modelling)
    2. [Data Engineering](https://github.com/alyssahondrade/sql-challenge/tree/main#data-engineering)
    3. [Data Analysis](https://github.com/alyssahondrade/sql-challenge/tree/main#data-analysis)
        - [Query Philosophy](https://github.com/alyssahondrade/sql-challenge/tree/main#query-philosophy)
3. [References](https://github.com/alyssahondrade/sql-challenge/tree/main#references)

## Introduction
### Goal
Design tables in a SQL database to hold the data contained in 6 CSV files, by performing: data modelling, data engineering, and data analysis. The CSV files contains information on employees, departments, and salaries.

### Repository Structure
Source code:
- [`schema.sql`](https://github.com/alyssahondrade/sql-challenge/blob/main/schema.sql) contains the queries to set up the schema.
- [`queries.sql`](https://github.com/alyssahondrade/sql-challenge/blob/main/queries.sql) contains the queries for the data analysis questions.
- [`ERD.png`](https://github.com/alyssahondrade/sql-challenge/blob/main/ERD.png) is the image file for the Entity-Relationship Diagram (ERD).

`EmployeeSQL` directory contains the CSV files:
- [`departments.csv`](https://github.com/alyssahondrade/sql-challenge/blob/main/EmployeeSQL/departments.csv) - Links the `dept_no` to `dept_name`.
- [`dept_emp.csv`](https://github.com/alyssahondrade/sql-challenge/blob/main/EmployeeSQL/dept_emp.csv) - Identifies which department each employee belongs to.
- [`dept_manager.csv`](https://github.com/alyssahondrade/sql-challenge/blob/main/EmployeeSQL/dept_manager.csv) - Identifies the managers for each department.
- [`employees.csv`](https://github.com/alyssahondrade/sql-challenge/blob/main/EmployeeSQL/employees.csv) - Contains information on each employee.
- [`salaries.csv`](https://github.com/alyssahondrade/sql-challenge/blob/main/EmployeeSQL/salaries.csv) - Identifies each employee's salary.
- [`titles.csv`](https://github.com/alyssahondrade/sql-challenge/blob/main/EmployeeSQL/titles.csv) - Links the `title_no` to the `title_name`.

### Dataset
The datasets were generated by **Mockaroo, LLC (2022) Realistic Data Generator**.

## Approach
### Data Modelling
Inspect the CSV files and sketch an Entity Relationship Diagram (ERD).
1. Identify keys:
    - Identify columns with unique values = __PRIMARY KEY__.
    - Identify columns that are common with other CSV files = __FOREIGN KEY__ (will need to use `REFERENCES`).
    - If there are CSV files with no unique values, create a __COMPOSITE KEY__ (more than one field as `PRIMARY KEY`).
2. Identify relationships:
    - `employees` & `titles`: One employee has one title, each title can be applicable to many employees.
    - `employees` & `salaries`: One employee has one salary, each salary can be applicable to many employees.
    - `employees` & `dept_emp`: One employee can belong to many departments, each department has many employees.
    - `employees` & `dept_manager`: One employee can only manage one department, each department has many managers.
    - `departments` & `dept_emp`: One department applies to many employees, each department can only have one department name.
    - `departments` & `dept_manager`: One department applies to many managers, each department can only have one department name.

| Entity-Relationship Diagram |
|:--:|
| ![ERD](https://github.com/alyssahondrade/sql-challenge/blob/main/ERD.png) |


### Data Engineering
Create a table schema for each CSV file. Order of import:

`titles`, `employees`, `departments`, `salaries`, `dept_emp`, `dept_manager`

Column value lengths are chosen by inspecting the columns in the given CSV files. In general:
1. It is assumed the current character length requirement for `title_id` and `dept_no` can handle capacity for future additions (for example, maximum of 999 departments for `dept_no`).

2. Name fields, such as `title`, `first_name`, `last_name`, and `dept_name`, are allocated reasonable character lengths to:
    - Account for current requirements (i.e. minimum is met), and
    - Allow for future additions which may be slightly longer.

Reasons for `NOT NULL`:
1. A field that is a `PRIMARY KEY` or a `FOREIGN KEY`.

2. If a table only has two fields, both fields are `NOT NULL`, otherwise what is the point of that entry.

3. For the `employees` table, `first_name` and `last_name` fields are left without the `NOT NULL` constraint to handle the possibility of people who only go by a mononym.

### Data Analysis
1. Employee details.
    - Use a subquery in the `SELECT` clause to include the monetary value for `salary` using `emp_no`.

2. Employeers hired in 1986.
    - Use `DATE_TRUNC` in the `WHERE` clause to get employees hired in the given year.
    - Confirm within limits by using `ORDER BY` and checking for `ASC` (start of year) and `DESC` (end of year).

3. Manager of each department.
    - Use `dept_manager` and `INNER JOIN` the tables `departments` and `employees`.
    - Confirm the correct number of results are returned by ensuring the rows match with `dept_manager`: 24 rows.

4. Employee with department name and number.
    - Use `employees` and `INNER JOIN` the tables `departments` and `employees`.
    - Store the result in a `VIEW` for following questions.
    - As each employee can have multiple departments, the `VIEW` result contains: `311603 rows` (Note: Further investigation revealed that an employee hired for multiple departments has one `hire_date`, identified by using `GROUP BY` with `HAVING COUNT(DISTINCT hire_date) > 1`).
        - Use `STRING_AGG` to get a column of department names and numbers for each employee.
        - Use `GROUP BY` on `emp_no` to get the result for each employee.
    - Confirm the correct number of results are returned by ensuring the rows match with `employees`: `300024 rows`.

5. Employee whose first name is `Hercules` and last name starts with `B`.
    - Use an `AND` in the `WHERE` clause to refine by both constraints.
    - Use `LIKE` to filter for the correct surname.

6. Sales department employees.
    - Use the `VIEW` created from __Question 4__ and filter for the given department.

7. Sales and Development departments.
    - Use the `VIEW` created from __Question 4__ and filter for the given departments.
    - Confirm there are unique `emp_no` by using `STRING_AGG` and `GROUP BY` as with __Question 4__.
        - NOTE: There are no employees which belong to both departments.
    - Drop the `VIEW` as it is no longer required.

8. Frequency counts (descending order) of all employee last names.
    - Use `COUNT` and `GROUP BY` to get the frequency counts.
    - Use `ORDER BY` on the aliased frequency counts and set to `DESC`.
    - Confirm the correct frequency counts are calculated.
        - Store the result in a `VIEW` and create a query to `SUM` all the frequencies.
        - Compare this result to the total number of rows in the `employees` table.

#### Query Philosophy
1. When building the query:
    - Identify the tables required, and determine whether a join or subquery is necessary.
    - Apply the constraints, returning all fields.
    - Refine the fields to return requested only.

2. Where both __JOIN__ and __SUBQUERY__ are applicable, for simplicity:
    - If multiple columns are required from multiple tables, use __JOIN__.
    - If only one column is required from a different table, use __SUBQUERY__.

## References
- [1] Composite Primary Keys in PostgreSQL [https://www.commandprompt.com/education/composite-primary-keys-in-postgresql/](https://www.commandprompt.com/education/composite-primary-keys-in-postgresql/)

- [2] Foreign Keys [https://www.postgresql.org/docs/current/tutorial-fk.html](https://www.postgresql.org/docs/current/tutorial-fk.html)

- [3] Data Types - Date/Time Types [https://www.postgresql.org/docs/current/datatype-datetime.html](https://www.postgresql.org/docs/current/datatype-datetime.html)

- [4] How to Compare Dates in PostgreSQL [https://www.commandprompt.com/education/how-to-compare-dates-in-postgresql/](https://www.commandprompt.com/education/how-to-compare-dates-in-postgresql/)

- [5] SQL Join vs Subquery [https://www.geeksforgeeks.org/sql-join-vs-subquery/](https://www.geeksforgeeks.org/sql-join-vs-subquery/)

- [6] How to concatenate strings of a string field in PostgreSQL 'group by' query? [https://stackoverflow.com/questions/43870/how-to-concatenate-strings-of-a-string-field-in-a-postgresql-group-by-query](https://stackoverflow.com/questions/43870/how-to-concatenate-strings-of-a-string-field-in-a-postgresql-group-by-query)

- [7] SQL Style Guide (Holywell) [https://www.sqlstyle.guide](https://www.sqlstyle.guide)